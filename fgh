#!/bin/bash
#
# fgh - finest-grained gh
#
# fgp プロキシの薄いクライアント。全てのコマンドを fgp の /cli エンドポイントに転送する。
#
# Usage:
#   fgh issue list
#   fgh pr view 123
#   fgh sub-issue list 123
#
# Environment:
#   FGP_PROXY_URL  - プロキシの URL (default: http://host.docker.internal:8766)
#

set -e

FGP_PROXY_URL="${FGP_PROXY_URL:-http://host.docker.internal:8766}"

# git remote から owner/repo を取得
get_repo_from_git() {
    local remote_url
    remote_url=$(git remote get-url origin 2>/dev/null) || return 1

    # パターン: github.com/owner/repo または host.docker.internal:8766/git/owner/repo
    if [[ "$remote_url" =~ github\.com[:/]([^/]+)/([^/.]+) ]]; then
        echo "${BASH_REMATCH[1]}/${BASH_REMATCH[2]}"
    elif [[ "$remote_url" =~ /git/([^/]+)/([^/.]+) ]]; then
        echo "${BASH_REMATCH[1]}/${BASH_REMATCH[2]}"
    fi
}

# -R/--repo オプションから owner/repo を取得
get_repo_from_args() {
    local args=("$@")
    for ((i=0; i<${#args[@]}; i++)); do
        if [[ "${args[i]}" == "-R" || "${args[i]}" == "--repo" ]]; then
            echo "${args[i+1]}"
            return
        fi
        if [[ "${args[i]}" =~ ^-R(.+)$ ]]; then
            echo "${BASH_REMATCH[1]}"
            return
        fi
        if [[ "${args[i]}" =~ ^--repo=(.+)$ ]]; then
            echo "${BASH_REMATCH[1]}"
            return
        fi
    done
}

# =============================================================================
# プロキシ経由の CLI 実行
# =============================================================================

# プロキシ経由で CLI コマンドを実行
call_proxy_cli() {
    local repo="$1"
    shift
    local args=("$@")

    # JSON 配列を構築
    local args_json="["
    local first=true
    for arg in "${args[@]}"; do
        if $first; then
            first=false
        else
            args_json="$args_json,"
        fi
        # 引数をエスケープして JSON 文字列に
        args_json="$args_json\"$(echo "$arg" | sed 's/"/\\"/g')\""
    done
    args_json="$args_json]"

    local result
    result=$(curl -s -X POST "${FGP_PROXY_URL}/cli" \
        -H "Content-Type: application/json" \
        -d "{\"args\":$args_json,\"repo\":\"$repo\"}")

    # エラーチェック（HTML エラーページ）
    if echo "$result" | grep -q '<!DOCTYPE'; then
        echo "$result" | grep -oP '(?<=<p>Message: ).*(?=</p>)' >&2
        return 1
    fi

    # exit_code をチェック
    local exit_code
    exit_code=$(echo "$result" | jq -r '.exit_code')
    local stdout
    stdout=$(echo "$result" | jq -r '.stdout')
    local stderr
    stderr=$(echo "$result" | jq -r '.stderr')

    if [[ "$exit_code" != "0" ]]; then
        echo "$stderr" >&2
        return "$exit_code"
    fi

    echo "$stdout"
}

# sub-issue コマンドのヘルプ
show_sub_issue_help() {
    cat <<'EOF'
Work with GitHub sub-issues.

USAGE
  fgh sub-issue <command> [flags]

COMMANDS
  list:     List sub-issues of an issue
  add:      Add a sub-issue to an issue
  remove:   Remove a sub-issue from an issue
  parent:   Show parent issue
  reorder:  Reorder sub-issues

FLAGS
  -R, --repo <owner/repo>   Specify repository (default: from git remote)

EXAMPLES
  fgh sub-issue list 123
  fgh sub-issue add 100 123
  fgh sub-issue parent 123
EOF
}

# sub-issue コマンドのメイン
handle_sub_issue() {
    local action="$1"

    # 引数なしならヘルプ表示
    if [[ -z "$action" ]]; then
        show_sub_issue_help
        return 0
    fi

    shift

    # repo を取得
    local repo
    repo=$(get_repo_from_args "$@")
    if [[ -z "$repo" ]]; then
        repo=$(get_repo_from_git)
    fi

    if [[ -z "$repo" ]]; then
        echo "Error: Could not determine repository. Use -R owner/repo" >&2
        return 1
    fi

    # -R を除いた引数を取得
    local args=()
    local skip_next=false
    for arg in "$@"; do
        if $skip_next; then
            skip_next=false
            continue
        fi
        if [[ "$arg" == "-R" || "$arg" == "--repo" ]]; then
            skip_next=true
            continue
        fi
        if [[ "$arg" =~ ^-R || "$arg" =~ ^--repo= ]]; then
            continue
        fi
        args+=("$arg")
    done

    # 引数バリデーションとプロキシ呼び出し
    case "$action" in
        list)
            local issue_number="${args[0]}"
            if [[ -z "$issue_number" ]]; then
                echo "accepts 1 arg(s), received 0" >&2
                return 1
            fi
            call_proxy_cli "$repo" "sub-issue" "list" "$issue_number"
            ;;
        add)
            local parent="${args[0]}"
            local child="${args[1]}"
            local received=${#args[@]}
            if [[ $received -lt 2 ]]; then
                echo "accepts 2 arg(s), received $received" >&2
                return 1
            fi
            call_proxy_cli "$repo" "sub-issue" "add" "$parent" "$child"
            ;;
        remove)
            local parent="${args[0]}"
            local child="${args[1]}"
            local received=${#args[@]}
            if [[ $received -lt 2 ]]; then
                echo "accepts 2 arg(s), received $received" >&2
                return 1
            fi
            call_proxy_cli "$repo" "sub-issue" "remove" "$parent" "$child"
            ;;
        parent)
            local child="${args[0]}"
            if [[ -z "$child" ]]; then
                echo "accepts 1 arg(s), received 0" >&2
                return 1
            fi
            call_proxy_cli "$repo" "sub-issue" "parent" "$child"
            ;;
        reorder)
            local parent="${args[0]}"
            local child="${args[1]}"
            local received=${#args[@]}
            if [[ $received -lt 2 ]]; then
                echo "accepts 2 arg(s), received $received" >&2
                return 1
            fi
            # --before/--after を探して proxy に渡す
            local reorder_args=("sub-issue" "reorder" "$parent" "$child")
            local i=2
            while [[ $i -lt ${#args[@]} ]]; do
                reorder_args+=("${args[i]}")
                i=$((i + 1))
            done
            call_proxy_cli "$repo" "${reorder_args[@]}"
            ;;
        *)
            echo "unknown command: $action" >&2
            return 1
            ;;
    esac
}

# メイン
main() {
    if [[ $# -eq 0 ]]; then
        echo "fgh - finest-grained gh"
        echo ""
        echo "Usage: fgh <command> [args...]"
        echo ""
        echo "Commands:"
        echo "  issue       Work with issues"
        echo "  pr          Work with pull requests"
        echo "  sub-issue   Work with sub-issues"
        echo "  api         Make API requests"
        echo ""
        echo "All commands are forwarded to fgp proxy."
        return 0
    fi

    local subcommand="$1"

    # sub-issue コマンドは特別扱い（引数バリデーション + ヘルプ）
    if [[ "$subcommand" == "sub-issue" ]]; then
        shift
        handle_sub_issue "$@"
        return
    fi

    # owner/repo を取得
    local repo
    repo=$(get_repo_from_args "$@")
    if [[ -z "$repo" ]]; then
        repo=$(get_repo_from_git)
    fi

    if [[ -z "$repo" ]]; then
        echo "Error: Could not determine repository. Use -R owner/repo" >&2
        return 1
    fi

    # 全てのコマンドを fgp に転送
    call_proxy_cli "$repo" "$@"
}

main "$@"
